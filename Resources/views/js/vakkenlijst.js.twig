$(document).ready(function(){
	$('#faculties').hide();
	$('#levels').hide();
	$('#studies').hide();
	$('#programs').hide();
	$('#stages').hide();
	$('#courses').hide();

	$.getJSON('{{ path('dellaert_kul_education_api_list_faculties_by_id_title', {'_locale': app.request.locale}) }}', function(data){
		var len = data.length;
		if( len == 0 ) {
			var html = '<option value="-1">{% trans %}no.faculty{% endtrans %}</option>'
		} else {
			var html = '<option value="-1">{% trans %}choose.faculty{% endtrans %}</option>';
		}
		for( var i=0; i < len; i++ ){
			html += '<option value="' + data[i].id + '">' + data[i].title + '</option>';
		}
		$('#faculties').html(html);
	});
	$('#faculties').show();

	$('#faculties').change(function(){
		$('#courses').hide();
		$('#courses').html('');
		$('#stages').hide();
		$('#stages').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');
		$('#programs').hide();
		$('#programs').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');
		$('#studies').hide();
		$('#studies').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');
		$('#levels').hide();
		$('#levels').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');

		if( $(this).val() != -1 ) {
			$.getJSON('{{ path('dellaert_kul_education_api_list_levels_by_id_title_noid', {'_locale': app.request.locale}) }}/' + $(this).val(), function(data) {
				var len = data.length;
				if( len == 0 ) {
					var html = '<option value="-1">{% trans %}no.level{% endtrans %}</option>'
				} else {
					var html = '<option value="-1">{% trans %}choose.level{% endtrans %}</option>';
				}
				for( var i=0; i < len; i++ ){
					html += '<option value="' + data[i].id + '">' + data[i].title + '</option>';
				}
				$('#levels').html(html);
			});
			$('#levels').show();
		}
	});

	$('#levels').change(function(){
		$('#courses').hide();
		$('#courses').html('');
		$('#stages').hide();
		$('#stages').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');
		$('#programs').hide();
		$('#programs').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');
		$('#studies').hide();
		$('#studies').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');

		if( $(this).val() != -1 ) {
			$.getJSON('{{ path('dellaert_kul_education_api_list_studies_by_id_title_noid', {'_locale': app.request.locale}) }}/' + $('#faculties').val() + '/' + $(this).val(), function(data) {
				var len = data.length;
				if( len == 0 ) {
					var html = '<option value="-1">{% trans %}no.study{% endtrans %}</option>'
				} else {
					var html = '<option value="-1">{% trans %}choose.study{% endtrans %}</option>';
				}
				for( var i=0; i < len; i++ ){
					html += '<option value="' + data[i].id + '">' + data[i].title + '</option>';
				}
				$('#studies').html(html);
			});
			$('#studies').show();
		}
	});

	$('#studies').change(function(){
		$('#courses').hide();
		$('#courses').html('');
		$('#stages').hide();
		$('#stages').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');
		$('#programs').hide();
		$('#programs').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');

		if( $(this).val() != -1 ) {
			$.getJSON('{{ path('dellaert_kul_education_api_list_programs_by_id_title_noid', {'_locale': app.request.locale}) }}/' + $(this).val(), function(data) {
				var len = data.length;
				if( len == 0 ) {
					var html = '<option value="-1">{% trans %}no.program{% endtrans %}</option>'
				} else {
					var html = '<option value="-1">{% trans %}choose.program{% endtrans %}</option>';
				}
				for( var i=0; i < len; i++ ){
					html += '<option value="' + data[i].id + '">' + data[i].title + ' (' + data[i].studypoints + ' {% trans %}studypoints{% endtrans %})</option>';
				}
				$('#programs').html(html);
			});
			$('#programs').show();
		}
	});

	$('#programs').change(function(){
		$('#courses').hide();
		$('#courses').html('');
		$('#stages').hide();
		$('#stages').html('<option value="-1">{% trans %}patience{% endtrans %}</option>');

		if( $(this).val() != -1 ) {
			$.getJSON('{{ path('dellaert_kul_education_api_list_stages_by_id_title_noid', {'_locale': app.request.locale}) }}/' + $(this).val(), function(data) {
				var len = data.length;
				if( len == 0 ) {
					var html = '<option value="-1">{% trans %}no.stage{% endtrans %}</option>'
				} else {
					var html = '<option value="-1">{% trans %}choose.stage{% endtrans %}</option>';
				}
				for( var i=0; i < len; i++ ){
					html += '<option value="' + data[i].id + '">{% trans %}stage{% endtrans %} ' + data[i].id + '</option>';
				}
				$('#stages').html(html);
			});
			$('#stages').show();
		}
	});

	$('#stages').change(function(){
		$('#courses').hide();
		$('#courses').html('');

		if( $(this).val() != -1 ) {
			$.getJSON('{{ path('dellaert_kul_education_api_list_courses_by_groups_in_level_noids', {'_locale': app.request.locale}) }}/' + $('#programs').val() + '/' + $(this).val(), function(data) {
				var html = '';

				html = handleCoursesByGroups(data,1);

				if( html == '' ) {
					html = '{% trans %}no.course{% endtrans %}';
				}

				$('#courses').html(html);

			    $('.show_hide').click(function(){
			    	if( $(this).next('.slidingDiv').hasClass('expanded') ) {
			    		$(this).next('.slidingDiv').slideUp(200);
			    		$(this).next('.slidingDiv').removeClass('expanded');
			    		$(this).next('.slidingDiv').addClass('closed');
			    		$(this).removeClass('expanded');
			    		$(this).addClass('closed');
			    	} else {
			    		$(this).next('.slidingDiv').slideDown(200);
			    		$(this).next('.slidingDiv').removeClass('closed');
			    		$(this).next('.slidingDiv').addClass('expanded');
			    		$(this).removeClass('closed');
			    		$(this).addClass('expanded');
			    	}
			    });

			    $('.expand_collapse_all').click(function(){
			    	if( $(this).hasClass('expanded_all') ) {
			    		$('.slidingDiv').slideUp(200);
			    		$('.slidingDiv').removeClass('expanded');
			    		$('.slidingDiv').addClass('closed');
			    		$(this).removeClass('expanded_all');
			    		$(this).addClass('closed_all');
			    		$('.expanded').addClass('closed');
			    		$('.expanded').removeClass('expanded');
			    		$(this).html('{% trans %}expand.all{% endtrans %}');
			    	} else {
			    		$('.slidingDiv').slideDown(200);
			    		$('.slidingDiv').removeClass('closed');
			    		$('.slidingDiv').addClass('expanded');
			    		$(this).removeClass('closed_all');
			    		$(this).addClass('expanded_all');
			    		$('.closed').addClass('expanded');
			    		$('.closed').removeClass('closed');
			    		$(this).html('{% trans %}close.all{% endtrans %}');
			    	}
			    });
			});
			$('#courses').slideDown(200);
		}
	});
});

function handleCourses(data) {
	var len = data.length;
	var html = '';

	html += '<table>';

	for( var i=0; i < len; i++ ) {

		html += '<tr><td width="30">'+data[i].studypoints+' {% trans %}studypoints{% endtrans %}</td>'
			+'<td>'+data[i].title+'</td>'
			+'<td width="20">';
			if( data[i].mandatory == 'J' ) {
				html += '<img width="16" src="{{ asset('bundles/dellaertaccobooklist/images/mandatory.png') }}" alt="mandatory" />';
			} else {
				html += '<img width="16" src="{{ asset('bundles/dellaertaccobooklist/images/optional.png') }}" alt="optional" />';
			}
			html +='</td>'
			+'<td width="20">'+data[i].period+'</td>'
			+'<td width="50">'+data[i].course_id+'</td>'
			+'<td width="20" class="teachers"><a href="#"> </a>';
		/*
		lenteachers = data[i].teachers.length;
		for( var j=0; j<lenteachers; j++ ) {
			html += data[i].teachers[j].name;
			if( j < lenteachers-1 ) {
				html += '; ';
			}
		}
		*/
		html += '</td></tr>';
	}

	html += '</table><br />';

	return html;
}

function handleCoursesByGroups(data,level) {
	var html = '';

	var sliding = false;

	for( fKey in data ) {
		if ( level > 1 && fKey != 'courses' ) {
			sliding = true;
		}

		if( level == 1 ) {
			html += '<p class="expand_collapse_all closed_all">{% trans %}expand.all{% endtrans %}</p>';
		}

		if( fKey != 'courses' ) {
			html += '<h'+level;

			if( sliding ) {
				html += ' class="show_hide closed"';
			}

			html += '>'+fKey+'</h'+level+'>';
		}

		if( sliding ) {
			html += '<div class="slidingDiv';
			if( level > 1 ) {
				html += ' level';
			}
			html += '">';
		} 

		if( fKey == 'courses' ) {
			html += handleCourses(data[fKey]);
		} else {
			html += handleCoursesByGroups(data[fKey],(level+1));
		}

		if( sliding ) {
			html += '</div>'
		}
	}

	return html;
}